// Exemplo: HTTP Server com Async/Threading integrado
// Demonstrando a soluÃ§Ã£o do problema Tokio

#<http_server>
#<console_io>

print("ğŸŒŸ === HTTP Server + Async/Threading === ğŸŒŸ");

// Classe para gerenciar servidor
class ServidorWeb {
    function init(nome, porta) {
        this.nome = nome;
        this.porta = porta;
        this.iniciado = false;
    }
    
    function configurar() {
        native_http_server_create(this.nome, "127.0.0.1", this.porta);
        
        // Configura rotas
        native_http_server_get(this.nome, "/", 
            "<h1>ğŸš€ Dryad WebServer</h1>" +
            "<p>Servidor HTTP nativo com threading!</p>" +
            "<ul>" +
            "<li><a href='/async'>Teste Async</a></li>" +
            "<li><a href='/api/status'>API Status</a></li>" +
            "</ul>"
        );
        
        native_http_server_get(this.nome, "/async",
            "<h2>âš¡ Async/Threading Ativo</h2>" +
            "<p>Este servidor roda com threads nativas, sem conflitos!</p>"
        );
        
        native_http_server_json(this.nome, "/api/status",
            '{"server": "Dryad", "threading": "native", "async": true}'
        );
        
        print("âœ… Servidor " + this.nome + " configurado na porta " + this.porta);
    }
    
    async function iniciar() {
        print("ğŸ”„ Iniciando servidor async...");
        native_http_server_start(this.nome);
        this.iniciado = true;
        print("ğŸš€ Servidor " + this.nome + " iniciado com sucesso!");
        return "servidor_iniciado";
    }
    
    function parar() {
        if (this.iniciado) {
            native_http_server_stop(this.nome);
            this.iniciado = false;
            print("ğŸ›‘ Servidor " + this.nome + " parado");
        }
    }
}

// Thread function para monitorar servidor
thread function monitorarServidor() {
    print("ğŸ‘€ Thread de monitoramento iniciada");
    print("ğŸ“Š Servidor funcionando com threads nativas!");
    return "monitoramento_ativo";
}

// FunÃ§Ã£o async para coordenaÃ§Ã£o
async function coordenarServidor() {
    print("ğŸ¯ Coordenador: Preparando ambiente...");
    
    // Cria mutex para sincronizaÃ§Ã£o
    let lock = mutex();
    print("ğŸ”’ Mutex criado para sincronizaÃ§Ã£o");
    
    // Inicia thread de monitoramento
    let monitor = thread(monitorarServidor);
    print("ğŸ§µ Thread de monitoramento ativa");
    
    return "coordenacao_completa";
}

// === EXECUÃ‡ÃƒO PRINCIPAL ===

print("1. Criando servidor web...");
let servidor = ServidorWeb("webapp", 9000);

print("2. Configurando rotas...");
servidor.configurar();

print("3. Coordenando recursos async/threading...");
let coordenacao = await coordenarServidor();
print("CoordenaÃ§Ã£o: " + coordenacao);

print("4. Iniciando servidor async...");
let resultado = await servidor.iniciar();
print("Resultado: " + resultado);

print("");
print("ğŸŒ Acesse: http://127.0.0.1:9000/");
print("ğŸ”— APIs: http://127.0.0.1:9000/api/status");
print("");
print("â° Rodando por 8 segundos...");

// Aguarda
native_sleep(8000);

print("5. Finalizando...");
servidor.parar();

print("");
print("âœ… SUCESSO: HTTP Server integrado com Async/Threading!");
print("ğŸ‰ Problema do Tokio resolvido com threads nativas!");