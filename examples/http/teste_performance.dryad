// Teste de Performance: HTTP Client vs Server
// Arquivo: http_performance_test.dryad

#<http_client>
#<http_server>
#<console_io>
#<time>

native_println("âš¡ TESTE DE PERFORMANCE HTTP");
native_println("=============================");

// FunÃ§Ã£o para medir tempo
fn measure_time(description, callback) {
    let start_time = native_time_now();
    callback();
    let end_time = native_time_now();
    let duration = end_time - start_time;
    native_println("   â±ï¸  " + description + ": " + duration + "ms");
    return duration;
}

// ========================
// PARTE 1: ConfiguraÃ§Ã£o do Servidor de Teste
// ========================

native_println("\nğŸ”§ PARTE 1: Configurando Servidor de Performance");

// Cria servidor dedicado para testes
native_http_server_create("perf_server", "127.0.0.1", 3999);

// Endpoint simples para testes de latÃªncia
native_http_server_json("perf_server", "/ping", '{"pong": true, "timestamp": 1632825600}');

// Endpoint com dados pequenos
native_http_server_json("perf_server", "/small", 
'{
    "id": 1,
    "status": "ok",
    "data": "small payload"
}');

// Endpoint com dados mÃ©dios
let medium_data = '{"users": [';
for (let i = 1; i <= 100; i++) {
    medium_data = medium_data + '{"id":' + i + ',"name":"User' + i + '","active":true}';
    if (i < 100) medium_data = medium_data + ',';
}
medium_data = medium_data + '],"total":100}';
native_http_server_json("perf_server", "/medium", medium_data);

// Endpoint com dados grandes
let large_data = '{"items": [';
for (let i = 1; i <= 1000; i++) {
    large_data = large_data + '{"id":' + i + ',"title":"Item ' + i + 
                 '","description":"Esta Ã© uma descriÃ§Ã£o mais longa para o item ' + i + 
                 ' que contÃ©m mais texto para aumentar o payload","category":"test","price":' + 
                 (i * 10.50) + ',"in_stock":true,"tags":["performance","test","data"]}';
    if (i < 1000) large_data = large_data + ',';
}
large_data = large_data + '],"total":1000,"page_size":1000}';
native_http_server_json("perf_server", "/large", large_data);

// Endpoint que simula processamento lento
native_http_server_json("perf_server", "/slow", '{"message": "processed after delay", "delay": "1000ms"}');

native_http_server_start("perf_server");
native_println("âœ… Servidor de performance iniciado na porta 3999");

// Aguarda inicializaÃ§Ã£o
native_sleep(500);

// ========================
// PARTE 2: ConfiguraÃ§Ã£o do Cliente
// ========================

native_println("\nğŸ“¡ PARTE 2: Configurando Cliente HTTP");

// Configura cliente otimizado
native_http_set_user_agent("http://127.0.0.1:3999", "Dryad-Performance-Test/1.0");
native_http_set_timeout("http://127.0.0.1:3999", 10000);
native_http_set_headers("http://127.0.0.1:3999", "Connection: keep-alive");

// ========================
// PARTE 3: Testes de LatÃªncia
// ========================

native_println("\nâš¡ PARTE 3: Testes de LatÃªncia (mÃºltiplas chamadas)");

let ping_times = [];
for (let i = 1; i <= 10; i++) {
    let duration = measure_time("Ping #" + i, fn() {
        let response = native_http_get("http://127.0.0.1:3999/ping");
    });
    ping_times.push(duration);
}

// Calcula estatÃ­sticas de latÃªncia
let total_time = 0;
let min_time = ping_times[0];
let max_time = ping_times[0];

for (let time in ping_times) {
    total_time = total_time + time;
    if (time < min_time) min_time = time;
    if (time > max_time) max_time = time;
}

let avg_time = total_time / ping_times.length;

native_println("\nğŸ“Š ESTATÃSTICAS DE LATÃŠNCIA:");
native_println("   MÃ­nimo:  " + min_time + "ms");
native_println("   MÃ¡ximo:  " + max_time + "ms");
native_println("   MÃ©dia:   " + avg_time + "ms");
native_println("   Total:   " + total_time + "ms");

// ========================
// PARTE 4: Testes de Throughput
// ========================

native_println("\nğŸ“ˆ PARTE 4: Testes de Throughput (diferentes tamanhos)");

// Teste com payload pequeno
let small_duration = measure_time("Payload Pequeno (10 requests)", fn() {
    for (let i = 1; i <= 10; i++) {
        let response = native_http_get("http://127.0.0.1:3999/small");
    }
});

// Teste com payload mÃ©dio
let medium_duration = measure_time("Payload MÃ©dio (5 requests)", fn() {
    for (let i = 1; i <= 5; i++) {
        let response = native_http_get("http://127.0.0.1:3999/medium");
    }
});

// Teste com payload grande
let large_duration = measure_time("Payload Grande (3 requests)", fn() {
    for (let i = 1; i <= 3; i++) {
        let response = native_http_get("http://127.0.0.1:3999/large");
    }
});

// ========================
// PARTE 5: Teste de ConcorrÃªncia Simulada
// ========================

native_println("\nğŸš€ PARTE 5: Teste de ConcorrÃªncia Simulada");

let concurrent_duration = measure_time("20 requisiÃ§Ãµes em sequÃªncia rÃ¡pida", fn() {
    for (let i = 1; i <= 20; i++) {
        let response = native_http_get("http://127.0.0.1:3999/ping");
        native_sleep(10); // Pequeno delay entre requisiÃ§Ãµes
    }
});

// ========================
// PARTE 6: Teste com APIs Externas
// ========================

native_println("\nğŸŒ PARTE 6: ComparaÃ§Ã£o com APIs Externas");

// Configura para API externa
native_http_set_timeout("https://httpbin.org", 5000);

let external_duration = measure_time("API Externa (httpbin.org)", fn() {
    let response = native_http_get("https://httpbin.org/json");
});

// ========================
// PARTE 7: Teste de Different HTTP Methods
// ========================

native_println("\nğŸ”„ PARTE 7: Performance de Diferentes MÃ©todos HTTP");

// Adiciona endpoint POST ao servidor
native_http_server_post("perf_server", "/test-post", '{"received": true, "method": "POST"}');

let get_duration = measure_time("GET requests (5x)", fn() {
    for (let i = 1; i <= 5; i++) {
        let response = native_http_get("http://127.0.0.1:3999/ping");
    }
});

let post_duration = measure_time("POST requests (5x)", fn() {
    native_http_set_headers("http://127.0.0.1:3999", "Content-Type: application/json");
    for (let i = 1; i <= 5; i++) {
        let response = native_http_post("http://127.0.0.1:3999/test-post", '{"test": true, "iteration": ' + i + '}');
    }
});

// ========================
// PARTE 8: RelatÃ³rio de Performance
// ========================

native_println("\nğŸ“‹ RELATÃ“RIO DE PERFORMANCE");
native_println("============================");

native_println("\nğŸ¯ LATÃŠNCIA:");
native_println("   â€¢ Resposta mais rÃ¡pida: " + min_time + "ms");
native_println("   â€¢ Resposta mais lenta:  " + max_time + "ms");
native_println("   â€¢ Tempo mÃ©dio:          " + avg_time + "ms");

native_println("\nğŸ“Š THROUGHPUT:");
native_println("   â€¢ Requests pequenos:    " + small_duration + "ms (10 requests)");
native_println("   â€¢ Requests mÃ©dios:      " + medium_duration + "ms (5 requests)");
native_println("   â€¢ Requests grandes:     " + large_duration + "ms (3 requests)");

native_println("\nğŸ”„ MÃ‰TODOS HTTP:");
native_println("   â€¢ GET Performance:      " + get_duration + "ms");
native_println("   â€¢ POST Performance:     " + post_duration + "ms");

native_println("\nğŸŒ COMPARAÃ‡ÃƒO:");
native_println("   â€¢ Servidor Local:       " + avg_time + "ms (mÃ©dia)");
native_println("   â€¢ API Externa:          " + external_duration + "ms");

// Calcula mÃ©tricas de performance
let local_rps = 10000 / avg_time; // Requests por segundo estimado
let efficiency = (avg_time < 50) ? "Excelente" : (avg_time < 100) ? "Boa" : "Precisa otimizaÃ§Ã£o";

native_println("\nâš¡ MÃ‰TRICAS CALCULADAS:");
native_println("   â€¢ RPS Estimado:         " + local_rps + " req/seg");
native_println("   â€¢ EficiÃªncia:           " + efficiency);
native_println("   â€¢ Overhead de Rede:     " + (external_duration - avg_time) + "ms");

// ========================
// PARTE 9: RecomendaÃ§Ãµes
// ========================

native_println("\nğŸ’¡ RECOMENDAÃ‡Ã•ES DE OTIMIZAÃ‡ÃƒO:");

if (avg_time < 10) {
    native_println("   âœ… Performance excelente! Sistema otimizado.");
} else if (avg_time < 50) {
    native_println("   âœ… Boa performance. Considere cache para melhores resultados.");
} else {
    native_println("   âš ï¸  Performance pode ser melhorada:");
    native_println("      â€¢ Verificar configuraÃ§Ãµes de rede");
    native_println("      â€¢ Implementar conexÃµes persistentes");
    native_println("      â€¢ Considerar compressÃ£o de dados");
}

if (large_duration > medium_duration * 3) {
    native_println("   ğŸ“¦ Payloads grandes afetam significativamente a performance");
    native_println("      â€¢ Considere paginaÃ§Ã£o para dados grandes");
    native_println("      â€¢ Implemente compressÃ£o GZIP");
}

if (post_duration > get_duration * 1.5) {
    native_println("   ğŸ”„ POST requests sÃ£o significativamente mais lentos");
    native_println("      â€¢ Verifique processamento de dados");
    native_println("      â€¢ Otimize validaÃ§Ã£o de entrada");
}

// ========================
// FINALIZAÃ‡ÃƒO
// ========================

native_println("\nâ° Mantendo servidor ativo por 30 segundos para testes manuais...");
native_println("   Teste manualmente: http://127.0.0.1:3999/ping");

native_sleep(30000);

native_http_server_stop("perf_server");
native_println("\nğŸ›‘ Servidor de performance parado!");
native_println("âœ¨ Teste de performance concluÃ­do!");

native_println("\nğŸ¯ RESUMO FINAL:");
native_println("   â€¢ Total de requisiÃ§Ãµes testadas: ~50+");
native_println("   â€¢ Tempo total de teste: ~" + (small_duration + medium_duration + large_duration + concurrent_duration + external_duration) + "ms");
native_println("   â€¢ Performance geral: " + efficiency);