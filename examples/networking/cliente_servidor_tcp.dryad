// Exemplo Completo TCP - Servidor Echo
// Demonstra TCP Server e Client integrados

#<tcp>
#<console_io>
#<time>

print("ğŸŒ === Exemplo TCP Server/Client === ğŸŒ");
print("");

// ===== CONFIGURAÃ‡ÃƒO DO SERVIDOR =====

print("ğŸ“‹ 1. Configurando TCP Server...");

// Verificar se porta estÃ¡ disponÃ­vel
let porta = 8090;
let porta_livre = tcp_port_available(porta);

if (!porta_livre) {
    print("âŒ Porta " + porta + " estÃ¡ em uso!");
    porta = porta + 1;
    print("ğŸ”„ Tentando porta " + porta);
}

// Criar servidor TCP
tcp_server_create("echo_server", "127.0.0.1", porta, 5);

// Configurar mÃ¡ximo de clientes
tcp_server_set_max_clients("echo_server", 10);

// Verificar status inicial
let status_inicial = tcp_server_status("echo_server");
print("âœ… Servidor criado: " + status_inicial.server_id);
print("   Host: " + status_inicial.host);
print("   Porta: " + status_inicial.port);
print("   Max clientes: " + status_inicial.max_clients);
if (status_inicial.is_running) {
    print("   Status: RODANDO");
} else {
    print("   Status: PARADO");
}

print("");

// ===== INICIANDO SERVIDOR =====

print("ğŸš€ 2. Iniciando TCP Server...");
tcp_server_start("echo_server");

// Aguardar servidor inicializar
// Aguardar inicializaÃ§Ã£o
native_sleep(500);

let status_rodando = tcp_server_status("echo_server");
print("âœ… Status apÃ³s iniciar: " + (status_rodando.is_running));

print("");

// ===== CONFIGURAÃ‡ÃƒO DO CLIENTE =====

print("ğŸ“± 3. Configurando TCP Client...");

// Obter IP local
let ip_local = tcp_get_local_ip();
print("ğŸŒ IP local detectado: " + ip_local);

// Resolver hostname local
let ip_resolvido = tcp_resolve_hostname("localhost");
print("ğŸ” Localhost resolvido para: " + ip_resolvido);

// Criar cliente TCP
tcp_client_create("cliente_echo", "127.0.0.1", porta);

// Configurar timeout
tcp_client_set_timeout("cliente_echo", 15);

let status_cliente = tcp_client_status("cliente_echo");
print("âœ… Cliente criado: " + status_cliente.client_id);
print("   Servidor: " + status_cliente.host + ":" + status_cliente.port);
print("   Timeout: " + status_cliente.timeout_secs + "s");
if (status_cliente.is_connected) {
    print("   Status: CONECTADO");
} else {
    print("   Status: DESCONECTADO");
}

print("");

// ===== TESTE DE COMUNICAÃ‡ÃƒO =====

print("ğŸ”— 4. Testando comunicaÃ§Ã£o TCP...");

// Conectar ao servidor
let conectado = tcp_client_connect("cliente_echo");

if (conectado) {
    print("âœ… Cliente conectado com sucesso!");
    
    // Enviar mensagem de teste
    let msg = "OlÃ¡ TCP Server!";
    
    print("ğŸ“¤ Enviando: " + msg);
    let enviado = tcp_client_send("cliente_echo", msg);
    
    if (enviado) {
        print("   âœ… Enviado com sucesso");
        
        // Aguardar um pouco
        native_sleep(200);
        
        // Tentar receber resposta
        let resposta = tcp_client_receive("cliente_echo");
        if (resposta != "") {
            print("ğŸ“¥ Resposta: " + resposta);
        } else {
            print("   âš ï¸ Nenhuma resposta recebida");
        }
    } else {
        print("   âŒ Falha ao enviar");
    }
    
    print("");
    
    // Desconectar cliente
    tcp_client_disconnect("cliente_echo");
    print("ğŸ‘‹ Cliente desconectado");
    
} else {
    print("âŒ Falha ao conectar cliente");
}

print("");

// ===== LIMPEZA =====

print("ğŸ§¹ 5. Finalizando...");

// Parar servidor
tcp_server_stop("echo_server");

let status_final = tcp_server_status("echo_server");
if (status_final.is_running) {
    print("ğŸ›‘ Servidor parado: AINDA RODANDO");
} else {
    print("ğŸ›‘ Servidor parado: PARADO");
}

print("");
print("âœ… Exemplo TCP finalizado com sucesso!");

// ===== ESTATÃSTICAS =====

print("");
print("ğŸ“Š === EstatÃ­sticas do Teste ===");
print("Servidor: " + status_inicial.server_id);
print("Porta utilizada: " + porta);
print("Cliente: " + status_cliente.client_id);
print("IP local: " + ip_local);
print("Teste concluÃ­do!");