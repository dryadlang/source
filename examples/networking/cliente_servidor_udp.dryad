// Exemplo Completo UDP - Echo Server
// Demonstra UDP Server e Client com datagramas

#<udp>
#<console_io>
#<time>

print("ğŸŒ === Exemplo UDP Server/Client === ğŸŒ");
print("");

// ===== CONFIGURAÃ‡ÃƒO DO SERVIDOR =====

print("ğŸ“‹ 1. Configurando UDP Server...");

// Verificar se porta estÃ¡ disponÃ­vel
let porta = 8070;
let porta_livre = udp_port_available(porta);

if (!porta_livre) {
    print("âŒ Porta " + porta + " nÃ£o estÃ¡ disponÃ­vel!");
    return;
} else {
    print("âœ… Porta " + porta + " estÃ¡ disponÃ­vel");
}

// Criar servidor UDP
udp_server_create("datagram_server", "127.0.0.1", porta);

// Verificar status inicial
let status_inicial = udp_server_status("datagram_server");
print("âœ… Servidor criado: " + status_inicial.server_id);
print("   Host: " + status_inicial.host);
print("   Porta: " + status_inicial.port);
if (status_inicial.is_running) {
    print("   Status: RODANDO");
} else {
    print("   Status: PARADO");
}

print("");

// ===== INICIANDO SERVIDOR =====

print("ğŸš€ 2. Iniciando UDP Server...");
udp_server_start("datagram_server");

// Aguardar inicializaÃ§Ã£o
native_sleep(500);

let status_rodando = udp_server_status("datagram_server");
print("âœ… Status apÃ³s iniciar: " + (status_rodando.is_running));

print("");

// ===== CONFIGURAÃ‡ÃƒO DO CLIENTE =====

print("ğŸ“± 3. Configurando UDP Client...");

// Obter IP local
let ip_local = udp_get_local_ip();
print("ğŸŒ IP local detectado: " + ip_local);

// Resolver hostname local
let ip_resolvido = udp_resolve_hostname("localhost");
print("ğŸ” Localhost resolvido para: " + ip_resolvido);

// Criar cliente UDP
udp_client_create("cliente_datagram", "127.0.0.1", porta);

// Configurar timeout do cliente
udp_client_set_timeout("cliente_datagram", 10);

// Verificar status do cliente
let status_cliente = udp_client_status("cliente_datagram");
print("âœ… Cliente criado: " + status_cliente.client_id);
print("   Servidor: " + status_cliente.host + ":" + status_cliente.port);
print("   Timeout: " + status_cliente.timeout_secs + "s");
if (status_cliente.is_bound) {
    print("   Status: VINCULADO");
} else {
    print("   Status: NÃƒO VINCULADO");
}

print("");

// ===== VINCULANDO CLIENTE =====

print("ğŸ”— 4. Vinculando UDP Client...");
let vinculado = udp_client_bind("cliente_datagram", 0);

if (vinculado) {
    print("âœ… Cliente vinculado com sucesso!");
    
    // Enviar mensagem de teste
    let msg = "OlÃ¡ UDP Server! Testando datagramas.";
    
    print("");
    print("ğŸ“¤ 5. Enviando mensagem:");
    print("   Dados: " + msg);
    
    let enviado = udp_client_send("cliente_datagram", msg);
    
    if (enviado) {
        print("   âœ… Enviado com sucesso");
        
        // Aguardar um pouco
        native_sleep(100);
        
        // Tentar receber resposta
        print("");
        print("ğŸ“¥ 6. Recebendo resposta:");
        let resposta = udp_client_receive("cliente_datagram");
        if (resposta != "") {
            print("   ğŸ“¦ Resposta: " + resposta);
        } else {
            print("   âš ï¸ Nenhuma resposta recebida");
        }
    } else {
        print("   âŒ Falha ao enviar");
    }
    
    print("");
    print("ğŸ“¡ 7. Teste de Send To (endereÃ§o especÃ­fico):");
    
    // Testar envio para endereÃ§o especÃ­fico
    let msg2 = "Mensagem via send_to";
    let enviado_to = udp_client_send_to("cliente_datagram", msg2, "127.0.0.1", porta);
    
    if (enviado_to) {
        print("   âœ… Send-to realizado com sucesso");
        
        native_sleep(100);
        
        // Testar recebimento com informaÃ§Ãµes do sender
        let resposta_from = udp_client_receive_from("cliente_datagram");
        if (resposta_from.data != "") {
            print("   ğŸ“¦ Dados: " + resposta_from.data);
            print("   ğŸ“ Remetente: " + resposta_from.sender);
        } else {
            print("   âš ï¸ Nenhum dado recebido do remetente");
        }
    }
    
    print("");
    print("ğŸ‘‹ 8. Fechando cliente...");
    udp_client_close("cliente_datagram");
    print("   âœ… Cliente fechado");
    
} else {
    print("âŒ Falha ao vincular cliente");
}

print("");

// ===== FINALIZANDO SERVIDOR =====

print("ğŸ›‘ 9. Finalizando servidor...");
udp_server_stop("datagram_server");

// Aguardar finalizaÃ§Ã£o
native_sleep(200);

let status_final = udp_server_status("datagram_server");
if (status_final.is_running) {
    print("ğŸ›‘ Servidor parado: AINDA RODANDO");
} else {
    print("ğŸ›‘ Servidor parado: PARADO");
}

print("");
print("âœ… Exemplo UDP finalizado com sucesso!");

// ===== ESTATÃSTICAS =====

print("");
print("ğŸ“Š === EstatÃ­sticas do Teste ===");
print("Servidor: " + status_inicial.server_id);
print("Porta utilizada: " + porta);
print("IP local: " + ip_local);
print("Protocolo: UDP (Datagramas)");
print("Teste concluÃ­do!");